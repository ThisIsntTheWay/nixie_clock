<html>
	<head>
		<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
		<link rel="icon" type="image/png" href="/favicon.png"/>
		
			<style>
				body { font-family: 'Roboto', sans-serif; }
				h4 { padding-bottom: 0px; }
			</style>
		<title>Nixie clock - RTC control</title>
		<script src="/js/websockets.js"></script>
		<script type="text/javascript">
			// Global stuff
			var message = null;
			
			var responseText = document.getElementById('response');
			var xhr = new XMLHttpRequest();

			xhr.onload = (res) => {
				message = res['target']['response'];
				responseText.innerHTML = JSON.stringify(message, null, "<br>");
			};

			window.onload = function() {			
				document.getElementById("ntp_config").style.display = "none";
				document.getElementById("manual_config").style.display = "none";
			}
			
			// Functions
			function showHideConfig() {
				var chkNTP = document.getElementById("ntp_control");
				var chMAN = document.getElementById("manual_control");
				var dvNTP = document.getElementById("ntp_config");
				var dvMAN = document.getElementById("manual_config");
				
				dvNTP.style.display = chkNTP.checked ? "block" : "none";
				dvMAN.style.display = chMAN.checked ? "block" : "none";
			}

			function forceSync() {				
				xhr.open("GET", "/api/RTCsync", true);

				xhr.send();
			}
			
			function submit() {
				var responseText = document.getElementById('response');
				var xhr = new XMLHttpRequest();
				
				// Form POST request
				xhr.open("POST", "/api/RTCendpoint", true);
				xhr.setRequestHeader('Content-Type', 'application/json');
				
				// Display server response at HTML element with ID 'response'
				xhr.onload = (res) => {
					message = res['target']['response'];
					responseText.innerHTML = message;
				};
				
				// Dispatch POST request
				if(document.getElementById("ntp_control").checked) {
					// Construct JSON object
					var obj = {mode: "ntp"};

					var ntp_source = document.getElementById("ntp_source").value;
					var gmt = document.getElementById("gmt").value;
					var dst = document.getElementById("dst").value;

					// Only include non-empty values
					if (ntp_source) {obj.value = ntp_source}
					if (gmt) {obj.gmt = gmt}
					if (dst) {obj.dst = dst}

					xhr.send(JSON.stringify(obj));

				} else if (chMAN = document.getElementById("manual_control").checked) {
					var tmp = document.getElementById("manual_time").value;
					xhr.send(JSON.stringify({
						"mode": "manual",
						"value": tmp
					}));
				}
			}
		</script>
	</head>
	<body>
		<center>
			<h1>RTC control</h1>
		<div>
			<h3>Change RTC settings</h3>
			Current time: <b>%RTC_TIME%</b><br>
			(As of page load)<br>
			<a href="#" onclick="forceSync()">Enforce sync</a><p>
			
			Current mode: <b>%TIME_MODE%</b><br>
			NTP server: <b>%NTP_SOURCE%</b><br>
			GMT value: <b>%GMT_VAL%</b><br>
			DST value: <b>%DST_VAL%</b><br><br>
			
			Set time source:<br>
			<input type="radio" id="ntp_control" name="r" onclick="showHideConfig()" />NTP<br>
			<input type="radio" id="manual_control" name="r" onclick="showHideConfig()" />Manual<br>
			<br>
			
			<span id="ntp_config">
				Set NTP server: <input type="numeric" size="16" id="ntp_source" value=""/><br>
				GMT offset: <input type="numeric" size="8" id="gmt" value="" maxlength="8" /><br>
				DST offset: <input type="numeric" size="8" id="dst" value="" maxlength="8" /><br>	
			</span>
			<span id="manual_config">
				Set manual time: <input type="numeric" size="16" id="manual_time" value=""/><br>
			</span>
			<br>
			<input type="submit" value="Apply" onclick="submit()"></input>
			<p id="response"></p>
		</div>
		</center>
	</body>
</html>